<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BT | Jackpot Arena</title>
    
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #6366f1;
            --accent: #06b6d4;
            --bg: #020617;
            --gold: #facc15;
            --glass: rgba(255, 255, 255, 0.03);
            --glass-border: rgba(255, 255, 255, 0.08);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body { 
            background: var(--bg); color: #f8fafc; min-height: 100vh; padding: 20px;
            background-image: radial-gradient(circle at top right, #1e1b4b, transparent);
        }

        .winner-ticker {
            background: rgba(250, 204, 21, 0.1); border: 1px solid rgba(250, 204, 21, 0.2);
            padding: 12px; border-radius: 50px; display: inline-flex; align-items: center; gap: 10px;
            margin-bottom: 25px; font-size: 13px; font-weight: 700; color: var(--gold);
        }

        .pool-card {
            background: linear-gradient(135deg, #1e1b4b, #0f172a);
            border: 2px solid var(--glass-border); border-radius: 30px;
            padding: 30px 20px; text-align: center; position: relative; overflow: hidden;
            box-shadow: 0 20px 40px rgba(0,0,0,0.5); margin-bottom: 25px;
        }

        .pool-amount { font-size: 42px; font-weight: 800; color: white; text-shadow: 0 0 20px rgba(6, 182, 212, 0.5); }
        .pool-label { font-size: 12px; font-weight: 800; color: var(--accent); letter-spacing: 2px; text-transform: uppercase; }

        .game-card {
            background: var(--glass); backdrop-filter: blur(20px); border-radius: 28px;
            padding: 25px; border: 1px solid var(--glass-border); margin-bottom: 25px;
            display: none; animation: slideUp 0.5s ease-out;
        }

        @keyframes slideUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .timer-circle {
            width: 70px; height: 70px; border: 4px solid var(--accent); border-radius: 50%;
            display: flex; align-items: center; justify-content: center; margin: 0 auto 20px;
            font-size: 20px; font-weight: 800; box-shadow: 0 0 15px var(--accent);
        }

        .opt {
            background: rgba(255,255,255,0.03); border: 1px solid var(--glass-border);
            padding: 16px; border-radius: 18px; margin-top: 10px; text-align: left;
            cursor: pointer; transition: 0.2s; font-weight: 600;
        }
        .opt:active { transform: scale(0.96); background: var(--primary); }

        .rank-card { background: var(--glass); border-radius: 28px; padding: 20px; border: 1px solid var(--glass-border); }
        .rank-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .rank-num { width: 30px; font-weight: 800; color: var(--accent); }
        .rank-name { flex: 1; font-weight: 600; margin-left: 10px; }
        .rank-score { background: rgba(99, 102, 241, 0.1); padding: 4px 12px; border-radius: 50px; font-weight: 800; color: var(--primary); }

        .btn-join {
            width: 100%; padding: 18px; border: none; border-radius: 20px;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            color: white; font-weight: 800; font-size: 16px; cursor: pointer;
            margin-top: 20px; box-shadow: 0 10px 25px rgba(99, 102, 241, 0.4);
        }
    </style>
</head>
<body>

    <div class="winner-ticker" id="lastWinner">
        <i class="ri-trophy-fill"></i> <span>Leader: Fetching...</span>
    </div>

    <div class="pool-card">
        <div class="pool-label">Jackpot Pool</div>
        <div class="pool-amount" id="pool">0 XP</div>
        <div style="font-size: 13px; opacity: 0.7; margin-top: 5px;">üî• <span id="players">0</span> Players Joined</div>
        <div style="font-size: 11px; margin-top: 15px; color: var(--accent);" id="myxp">My XP: 0</div>
        <button class="btn-join" id="enterBtn" onclick="enter()">ENTER ARENA (50 XP)</button>
    </div>

    <div class="game-card" id="gameBox">
        <div class="timer-circle" id="timer">60</div>
        <h3 id="q" style="margin-bottom: 20px; line-height: 1.4;">Question loading...</h3>
        <div id="options"></div>
        <div style="margin-top: 20px; font-weight: 800; color: var(--accent);">Score: <span id="score">0</span></div>
    </div>

    <div class="rank-card">
        <h3 style="margin-bottom: 15px; font-weight: 800; display: flex; align-items: center; gap: 10px;">
            <i class="ri-bar-chart-fill" style="color:var(--accent)"></i> Live Ranking
        </h3>
        <div id="ranking">
            <p style="text-align: center; opacity: 0.5; padding: 20px;">Fetching warriors...</p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, addDoc, getDocs, query, orderBy, limit, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCEYfwfZv2Ckpg-uFLRvJkMBRlXA2w_WpI",
            authDomain: "black-terminal-f2c91.firebaseapp.com",
            projectId: "black-terminal-f2c91",
            storageBucket: "black-terminal-f2c91.appspot.com",
            messagingSenderId: "552489994197",
            appId: "1:552489994197:web:7662331264c334ffbadf5c"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let student = localStorage.getItem("studentName") || "Guest";
        let myxp = 0;
        let score = 0;
        let qIndex = 0;
        let timeLeft = 60;
        let totalPoolAmount = 0;

        async function checkDailyReset() {
            const todayDate = new Date().toDateString();
            const resetRef = doc(db, "system", "last_reset");
            const resetSnap = await getDoc(resetRef);

            if (!resetSnap.exists() || resetSnap.data().date !== todayDate) {
                // Raat 12 baje ke baad pehla login: Sab delete karo
                const q = await getDocs(collection(db, "tournament_today"));
                const deletePromises = q.docs.map(d => deleteDoc(doc(db, "tournament_today", d.id)));
                await Promise.all(deletePromises);
                
                // Update reset date
                await setDoc(resetRef, { date: todayDate });
                console.log("Daily Reset Done!");
            }
        }

        async function init() {
            try {
                await checkDailyReset();
                const snap = await getDoc(doc(db, "students", student));
                if (snap.exists()) {
                    myxp = snap.data().xp || 0;
                }
                document.getElementById("myxp").innerText = "MY XP: " + myxp;
                
                await loadPool();
                await loadLastWinner();
            } catch(e) { console.error(e); }
        }
        init();

        async function loadLastWinner() {
            try {
                const q = query(collection(db, "tournament_today"), orderBy("score", "desc"), limit(1));
                const snap = await getDocs(q);
                const winnerDiv = document.getElementById("lastWinner");
                
                if (!snap.empty) {
                    const top = snap.docs[0].data();
                    if(top.score > 0) {
                        winnerDiv.innerHTML = `<i class="ri-trophy-fill"></i> <span>Leader: ${top.name} (${top.score} pts)</span>`;
                    } else {
                        winnerDiv.innerHTML = `<i class="ri-trophy-fill"></i> <span>Battle Started!</span>`;
                    }
                } else {
                    winnerDiv.innerHTML = `<i class="ri-trophy-fill"></i> <span>No Leader Yet</span>`;
                }
            } catch(e) { console.error(e); }
        }

        async function loadPool() {
            const snap = await getDocs(collection(db, "tournament_today"));
            let total = 0, count = 0;
            snap.forEach(d => { total += (d.data().entry || 50); count++; });
            totalPoolAmount = total;
            document.getElementById("pool").innerText = total + " XP";
            document.getElementById("players").innerText = count;
            loadRanking();
        }

        window.enter = async function() {
            if (myxp < 50) return alert("‚ùå Need 50 XP!");
            document.getElementById("enterBtn").disabled = true;

            try {
                await updateDoc(doc(db, "students", student), { xp: myxp - 50 });
                myxp -= 50;
                document.getElementById("myxp").innerText = "MY XP: " + myxp;
                await addDoc(collection(db, "tournament_today"), { name: student, score: 0, entry: 50 });
                document.getElementById("enterBtn").style.display = "none";
                startGame();
            } catch(e) { alert(e.message); }
        }

        const questions = [
            {q:"What is the brain of a computer?", a:"Monitor", b:"Keyboard", c:"CPU", d:"Mouse", ans:"C"},
            {q:"Which device is used for typing?", a:"Keyboard", b:"Mouse", c:"Printer", d:"Speaker", ans:"A"},
            {q:"What does ROM stand for?", a:"Read Only Memory", b:"Random Only Memory", c:"Read Open Memory", d:"Read One Memory", ans:"A"},
            {q:"Which is an input device?", a:"Monitor", b:"Printer", c:"Scanner", d:"Speaker", ans:"C"},
            {q:"Who developed World Wide Web (WWW)?", a:"Bill Gates", b:"Tim Berners-Lee", c:"Steve Jobs", d:"Mark Zuckerberg", ans:"B"},
            {q:"What is the shortcut for Paste?", a:"Ctrl+P", b:"Ctrl+C", c:"Ctrl+V", d:"Ctrl+X", ans:"C"},
            {q:"Which of these is an Operating System?", a:"Google", b:"Windows", c:"Facebook", d:"MS Word", ans:"B"},
            {q:"What is the full form of PDF?", a:"Print Document File", b:"Portable Data File", c:"Portable Document Format", d:"Personal Data File", ans:"C"},
            {q:"Which part of computer displays the work?", a:"CPU", b:"Monitor", c:"UPS", d:"RAM", ans:"B"},
            {q:"What is the shortcut to Undo?", a:"Ctrl+Z", b:"Ctrl+U", c:"Ctrl+Y", d:"Ctrl+S", ans:"A"},
            {q:"1 Megabyte (MB) is equal to?", a:"1024 KB", b:"1000 KB", c:"1024 GB", d:"100 KB", ans:"A"},
            {q:"What is the full form of HTTP?", a:"High Text Transfer Protocol", b:"Hyper Text Transfer Protocol", c:"Hyper Tool Transfer Process", d:"Hidden Text Transfer Plot", ans:"B"},
            {q:"Which is the smallest unit of data?", a:"Bit", b:"Byte", c:"Nibble", d:"KB", ans:"A"},
            {q:"Which device is used for gaming?", a:"Joystick", b:"Printer", c:"UPS", d:"CPU", ans:"A"},
            {q:"Who is the founder of Microsoft?", a:"Jeff Bezos", b:"Elon Musk", c:"Bill Gates", d:"Mark Zuckerberg", ans:"C"},
            {q:"What is the shortcut to Save?", a:"Ctrl+S", b:"Ctrl+A", c:"Ctrl+V", d:"Ctrl+P", ans:"A"},
            {q:"Which of these is a web browser?", a:"Google Chrome", b:"MS Paint", c:"Excel", d:"PowerPoint", ans:"A"},
            {q:"What is the full form of LAN?", a:"Long Area Network", b:"Local Area Network", c:"Light Area Network", d:"Low Area Network", ans:"B"},
            {q:"Which is a permanent storage device?", a:"RAM", b:"Cache", c:"Hard Disk", d:"Register", ans:"C"},
            {q:"What does GUI stand for?", a:"Global User Index", b:"Graphical User Interface", c:"General User Icon", d:"Google User Info", ans:"B"},
            {q:"Which key is used to delete a file?", a:"Delete", b:"Shift", c:"Esc", d:"Alt", ans:"A"},
            {q:"What is the extension of MS Word file?", a:".xlsx", b:".pptx", c:".docx", d:".txt", ans:"C"},
            {q:"Which is the physical part of computer?", a:"Software", b:"Hardware", c:"Malware", d:"Firmware", ans:"B"},
            {q:"What is the full form of URL?", a:"Unique Resource Link", b:"Uniform Resource Locator", c:"United Resource Line", d:"User Resource Link", ans:"B"},
            {q:"Which shortcut is used to select all?", a:"Ctrl+S", b:"Ctrl+C", c:"Ctrl+A", d:"Ctrl+Z", ans:"C"},
            {q:"What is the full form of Wi-Fi?", a:"Wireless Fidelity", b:"Wire First", c:"Wireless Focus", d:"Wire Fiber", ans:"A"},
            {q:"Which is the main page of a website?", a:"Link page", b:"First page", c:"Home page", d:"Main page", ans:"C"},
            {q:"What is the full form of USB?", a:"Universal Serial Bus", b:"User Serial Bus", c:"Unique Serial Bus", d:"Unit Serial Bus", ans:"A"},
            {q:"Which is an output device?", a:"Keyboard", b:"Mouse", c:"Printer", d:"Scanner", ans:"C"},
            {q:"What is the full form of BIOS?", a:"Basic Input Output System", b:"Beginner Input Output Set", c:"Basic Interface Output System", d:"Big Input Output System", ans:"A"},
            {q:"Who is the founder of Facebook?", a:"Bill Gates", b:"Mark Zuckerberg", c:"Elon Musk", d:"Larry Page", ans:"B"},
            {q:"What is the shortcut to Print?", a:"Ctrl+X", b:"Ctrl+P", c:"Ctrl+S", d:"Ctrl+A", ans:"B"},
            {q:"Which is the largest network?", a:"LAN", b:"MAN", c:"Internet", d:"WAN", ans:"C"},
            {q:"What is the full form of CPU?", a:"Central Processing Unit", b:"Control Processing Unit", c:"Core Processing Unit", d:"Computer Processing Unit", ans:"A"},
            {q:"Which key is used for help?", a:"F1", b:"F2", c:"F5", d:"F12", ans:"A"},
            {q:"What is the brain of the robot?", a:"Controller", b:"Sensor", c:"Battery", d:"Motor", ans:"A"},
            {q:"What is a computer virus?", a:"Insects", b:"Bacteria", c:"Software Program", d:"Hardware Part", ans:"C"},
            {q:"Which is the most popular search engine?", a:"Bing", b:"Yahoo", c:"Google", d:"DuckDuckGo", ans:"C"},
            {q:"What is the shortcut for Bold?", a:"Ctrl+V", b:"Ctrl+I", c:"Ctrl+B", d:"Ctrl+U", ans:"C"},
            {q:"1 Gigabyte (GB) is equal to?", a:"1024 MB", b:"1000 MB", c:"1024 KB", d:"512 MB", ans:"A"},
            {q:"What is the ALU full form?", a:"Arithmetic Logic Unit", b:"All Logic Unit", c:"Area Logic Unit", d:"Auto Logic Unit", ans:"A"},
            {q:"Which device is used for voice input?", a:"Microphone", b:"Speaker", c:"Monitor", d:"Mouse", ans:"A"},
            {q:"What is the shortcut for New File?", a:"Ctrl+N", b:"Ctrl+O", c:"Ctrl+M", d:"Ctrl+F", ans:"A"},
            {q:"Which company made Android?", a:"Apple", b:"Microsoft", c:"Google", d:"Samsung", ans:"C"},
            {q:"What is the IP full form?", a:"Internet Protocol", b:"Internal Process", c:"Index Point", d:"Internet Process", ans:"A"},
            {q:"Which is used to refresh a page?", a:"F1", b:"F5", c:"F10", d:"Esc", ans:"B"},
            {q:"What is the HDD full form?", a:"Hard Disk Drive", b:"High Data Drive", c:"Hidden Data Disk", d:"Hard Data Drive", ans:"A"},
            {q:"Which is a social media app?", a:"MS Excel", b:"Instagram", c:"Photoshop", d:"NotePad", ans:"B"},
            {q:"What is the shortcut to Cut?", a:"Ctrl+C", b:"Ctrl+X", c:"Ctrl+V", d:"Ctrl+Z", ans:"B"},
            {q:"What is the OS full form?", a:"Open System", b:"Operating System", c:"Output System", d:"Order System", ans:"B"}
        ];

        function startGame() {
            document.getElementById("gameBox").style.display = "block";
            showQuestion();
            const timer = setInterval(() => {
                timeLeft--;
                document.getElementById("timer").innerText = timeLeft;
                if (timeLeft <= 0) { clearInterval(timer); finish(); }
            }, 1000);
        }

        function showQuestion() {
            if (qIndex >= 50) return finish();
            const q = questions[qIndex];
            document.getElementById("q").innerText = `Q${qIndex+1}. ${q.q}`;
            document.getElementById("options").innerHTML = `
                <div class="opt" onclick="check('A')">A. ${q.a}</div>
                <div class="opt" onclick="check('B')">B. ${q.b}</div>
                <div class="opt" onclick="check('C')">C. ${q.c}</div>
                <div class="opt" onclick="check('D')">D. ${q.d}</div>
            `;
        }

        window.check = function(v) {
            if (v == questions[qIndex].ans) { score++; document.getElementById("score").innerText = score; }
            qIndex++; showQuestion();
        }

        async function finish() {
            document.getElementById("gameBox").innerHTML = `
                <div style="text-align:center; padding:20px;">
                    <h2 style="color:var(--gold)">BATTLE ENDED</h2>
                    <h1 style="font-size:40px;">Score: ${score}</h1>
                    <p id="rewardMsg">Updating Leaderboard & XP...</p>
                    <button onclick="location.href='index.html'" style="margin-top:20px; padding:12px 24px; border-radius:12px; background:var(--primary); color:white; border:none; font-weight:800;">GO HOME</button>
                </div>`;
            
            try {
                // 1. Update score in daily tournament
                const snap = await getDocs(collection(db, "tournament_today"));
                let dId = null;
                snap.forEach(d => { if(d.data().name === student) dId = d.id; });
                if(dId) await updateDoc(doc(db, "tournament_today", dId), { score: score });

                // 2. CHECK IF PLAYER IS #1 AND UPDATE MAIN ACCOUNT XP
                const q = query(collection(db, "tournament_today"), orderBy("score", "desc"), limit(1));
                const topSnap = await getDocs(q);
                
                if (!topSnap.empty && topSnap.docs[0].data().name === student) {
                    const studentRef = doc(db, "students", student);
                    const currentSnap = await getDoc(studentRef);
                    if (currentSnap.exists()) {
                        const newXP = (currentSnap.data().xp || 0) + totalPoolAmount;
                        await updateDoc(studentRef, { xp: newXP });
                        document.getElementById("rewardMsg").innerHTML = `<b style="color:var(--gold)">üèÜ JACKPOT! ${totalPoolAmount} XP added to your account!</b>`;
                    }
                }
                
                await loadRanking();
                await loadLastWinner();
            } catch(e) { console.error(e); }
        }

        async function loadRanking() {
            const snap = await getDocs(collection(db, "tournament_today"));
            let users = [];
            snap.forEach(d => users.push(d.data()));
            users.sort((a, b) => b.score - a.score);
            document.getElementById("ranking").innerHTML = users.map((u, i) => `
                <div class="rank-item">
                    <span class="rank-num">#${i+1}</span>
                    <span class="rank-name">${u.name}</span>
                    <span class="rank-score">${u.score} pts</span>
                </div>
            `).join('') || "<p style='text-align:center;padding:20px;opacity:0.5;'>No warriors joined yet.</p>";
        }
    </script>
</body>
</html>
