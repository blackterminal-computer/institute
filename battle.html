<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>1 vs 1 Battle</title>
<style>
body{background:#020617;color:white;font-family:Arial;text-align:center;padding-top:60px}
.card{background:#0f172a;padding:25px;border-radius:16px;width:92%;max-width:420px;margin:auto}
.option{background:#1e293b;padding:14px;margin:8px;border-radius:10px;cursor:pointer}
.timer{color:#22c55e;font-size:20px;margin:10px}
</style>
</head>
<body>
<div class="card" id="screen">
<h2>üîç Searching opponent...</h2>
</div>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, getDoc, deleteDoc }
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig={
apiKey:"AIzaSyCEYfwfZv2Ckpg-uFLRvJkMBRlXA2w_WpI",
authDomain:"black-terminal-f2c91.firebaseapp.com",
projectId:"black-terminal-f2c91",
storageBucket:"black-terminal-f2c91.appspot.com",
messagingSenderId:"552489994197",
appId:"1:552489994197:web:7662331264c334ffbadf5c"
};

const app=initializeApp(firebaseConfig);
const db=getFirestore(app);

let student=localStorage.getItem("studentName")||prompt("Enter name");
localStorage.setItem("studentName",student);

let roomId="";
let opponent="";

start();

async function start(){

// üî• always create fresh room
const ref = await addDoc(collection(db,"battle_wait"),{
name:student,
status:"waiting",
time:Date.now()
});

roomId = ref.id;

// üî• keep checking for opponent
const check = setInterval(async()=>{

let snap = await getDoc(doc(db,"battle_wait",roomId));
let d = snap.data();

if(!d) return;

if(d.p2 && d.status=="start"){
clearInterval(check);

if(d.name==student){
opponent=d.p2;
}else{
opponent=d.name;
}

startGame();
}

},1500);


// üî• join any fresh waiting room
let snapAll = await getDocs(collection(db,"battle_wait"));
snapAll.forEach(async(docu)=>{

let data = docu.data();

// join only fresh room (5 sec)
if(data.status=="waiting" 
&& data.name!=student 
&& (Date.now()-data.time)<5000){

try{
await updateDoc(doc(db,"battle_wait",docu.id),{
p2:student,
status:"start"
});
}catch{}

}

});

}

let questions=[
{q:"Brain of computer?",a:"RAM",b:"CPU",c:"Mouse",d:"Keyboard",ans:"b"},
{q:"HTML full form?",a:"Hyper Trainer",b:"Hyper Text Markup Language",c:"High Text",d:"None",ans:"b"},
{q:"Keyboard is?",a:"Input",b:"Output",c:"CPU",d:"RAM",ans:"a"},
{q:"1KB?",a:"1000",b:"1024",c:"500",d:"2000",ans:"b"},
{q:"Windows?",a:"OS",b:"Game",c:"File",d:"None",ans:"a"},
{q:"Excel?",a:"Software",b:"Game",c:"OS",d:"None",ans:"a"},
{q:"Mouse?",a:"Input",b:"Output",c:"CPU",d:"RAM",ans:"a"},
{q:"Printer?",a:"Output",b:"Input",c:"CPU",d:"RAM",ans:"a"},
{q:"Binary of 2?",a:"10",b:"11",c:"01",d:"00",ans:"a"},
{q:"Internet needs?",a:"CPU",b:"Network",c:"RAM",d:"Mouse",ans:"b"}
];

let i=0,score=0,time=10,timer;

function startGame(){
document.getElementById("screen").innerHTML=`
<h2>‚öî ${student} vs ${opponent}</h2>
<div class="timer">‚è± <span id="t">10</span></div>
<h3 id="q"></h3>
<div id="opts"></div>`;
loadQ();
}

function loadQ(){
if(i>=10){finish();return;}
time=10;
document.getElementById("t").innerText=time;
let q=questions[i];
document.getElementById("q").innerText=q.q;
document.getElementById("opts").innerHTML=`
<div class="option" onclick="ans('a')">${q.a}</div>
<div class="option" onclick="ans('b')">${q.b}</div>
<div class="option" onclick="ans('c')">${q.c}</div>
<div class="option" onclick="ans('d')">${q.d}</div>`;
clearInterval(timer);
timer=setInterval(()=>{time--;document.getElementById("t").innerText=time;if(time<=0){i++;loadQ();}},1000);
}

window.ans=(a)=>{if(a==questions[i].ans)score++;i++;loadQ();}

async function finish(){
clearInterval(timer);
await updateDoc(doc(db,"battle_wait",roomId),{[student]:score});

setTimeout(async()=>{
let snap=await getDoc(doc(db,"battle_wait",roomId));
let d=snap.data();
let s1=d[d.name]||0;
let s2=d[d.p2]||0;
let win=(student==d.name?(s1>s2):(s2>s1));
let xp=win?100:-10;

document.getElementById("screen").innerHTML=`
<h1>${win?"üèÜ You Win":"üò¢ You Lose"}</h1>
<h2>Score ${score}</h2>
<h3>XP ${xp}</h3>
<button onclick="location.href='index.html'">Home</button>`;

let ref=doc(db,"students",student);
let s=await getDoc(ref);
if(s.exists()){
let x=s.data().xp||0;
x+=xp;if(x<0)x=0;
await updateDoc(ref,{xp:x});
}

setTimeout(async()=>{try{await deleteDoc(doc(db,"battle_wait",roomId));}catch{}},4000);

},2000);
}
</script>
</body>
</html>
