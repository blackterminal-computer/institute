<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Simple Battle</title>

<style>
body{
background:#020617;
color:white;
font-family:Arial;
text-align:center;
padding-top:60px;
}

.card{
background:#0f172a;
padding:20px;
border-radius:16px;
width:92%;
max-width:420px;
margin:auto;
}

button{
padding:14px;
border:none;
border-radius:10px;
margin:8px;
font-weight:bold;
width:90%;
background:#2563eb;
color:white;
}

.win{color:#22c55e;font-size:22px}
.lose{color:#ef4444;font-size:22px}
.draw{color:orange;font-size:22px}
</style>
</head>
<body>

<div class="card">

<h2 id="status">ğŸ” Finding opponent...</h2>

<h3 id="question"></h3>
<div id="options"></div>

<h3>Score: <span id="myscore">0</span></h3>
<h3>Opponent: <span id="oppscore">0</span></h3>

<h2 id="result"></h2>

</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, updateDoc, doc, onSnapshot, getDoc }
from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

const firebaseConfig = {
apiKey: "AIzaSyCEYfwfZv2Ckpg-uFLRvJkMBRlXA2w_WpI",
authDomain: "black-terminal-f2c91.firebaseapp.com",
projectId: "black-terminal-f2c91",
storageBucket: "black-terminal-f2c91.appspot.com",
messagingSenderId: "552489994197",
appId: "1:552489994197:web:7662331264c334ffbadf5c"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let student = localStorage.getItem("studentName");
if(!student){
student = prompt("Enter name");
localStorage.setItem("studentName",student);
}

let myScore=0;
let battleId="";
let qIndex=0;

let questions=[
{q:"Brain of computer?",o:["RAM","CPU","Mouse","Keyboard"],a:"CPU"},
{q:"Copy shortcut?",o:["Ctrl+C","Ctrl+V","Ctrl+X","Ctrl+P"],a:"Ctrl+C"},
{q:"WWW full form?",o:["World Wide Web","Web World","Wide Web","None"],a:"World Wide Web"},
{q:"Excel file?",o:[".xls",".png",".mp3",".exe"],a:".xls"},
{q:"Input device?",o:["Keyboard","Monitor","Speaker","Printer"],a:"Keyboard"}
];

// MATCH
async function findMatch(){

let snap=await getDocs(collection(db,"battles"));
let found=false;

snap.forEach(async(d)=>{
let data=d.data();
if(!data.p2 && data.p1!=student && !found){
found=true;

battleId=d.id;

await updateDoc(doc(db,"battles",battleId),{
p2:student,
score1:0,
score2:0,
finished:false
});

listenBattle();
}
});

if(!found){
let ref=await addDoc(collection(db,"battles"),{
p1:student,
p2:"",
score1:0,
score2:0,
finished:false
});
battleId=ref.id;
listenBattle();
}

}

findMatch();

// LISTEN
function listenBattle(){

onSnapshot(doc(db,"battles",battleId),(snap)=>{

let d=snap.data();
if(!d) return;

if(d.p2){
document.getElementById("status").innerHTML="âš” "+d.p1+" VS "+d.p2;
showQuestion();
}

let my=(student==d.p1)?d.score1:d.score2;
let opp=(student==d.p1)?d.score2:d.score1;

document.getElementById("myscore").innerHTML=my;
document.getElementById("oppscore").innerHTML=opp;

if(d.finished){
showResult(d);
}

});

}

// QUESTION
function showQuestion(){

if(qIndex>=questions.length){
finishBattle();
return;
}

let q=questions[qIndex];
document.getElementById("question").innerHTML=q.q;

let html="";
q.o.forEach(opt=>{
html+=`<button onclick="answer('${opt}')">${opt}</button>`;
});

document.getElementById("options").innerHTML=html;
}

// ANSWER
window.answer = async function(opt){

let q=questions[qIndex];
if(opt==q.a) myScore++;

let ref=doc(db,"battles",battleId);
let snap=await getDoc(ref);
let d=snap.data();

if(student==d.p1){
await updateDoc(ref,{score1:myScore});
}else{
await updateDoc(ref,{score2:myScore});
}

qIndex++;
showQuestion();
}

// FINISH
async function finishBattle(){

let ref=doc(db,"battles",battleId);
let snap=await getDoc(ref);
let d=snap.data();

if(d.finished) return;

let winner="draw";
if(d.score1>d.score2) winner=d.p1;
if(d.score2>d.score1) winner=d.p2;

await updateDoc(ref,{finished:true,winner:winner});

}

// RESULT
function showResult(d){

let my=(student==d.p1)?d.score1:d.score2;
let opp=(student==d.p1)?d.score2:d.score1;

let res=document.getElementById("result");

if(d.winner==student){
res.innerHTML="ğŸ† You Win";
res.className="win";
}
else if(d.winner=="draw"){
res.innerHTML="ğŸ¤ Draw";
res.className="draw";
}
else{
res.innerHTML="ğŸ˜¢ You Lose";
res.className="lose";
}

}

</script>
</body>
</html>