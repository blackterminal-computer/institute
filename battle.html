<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>1 vs 1 Battle</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;600;700&display=swap" rel="stylesheet">

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:Poppins}
body{
background:#020617;
color:white;
display:flex;
justify-content:center;
align-items:center;
height:100vh;
flex-direction:column;
}

/* waiting */
#wait{text-align:center}
.loader{
margin-top:20px;width:60px;height:60px;
border:5px solid #111;border-top:5px solid #06b6d4;
border-radius:50%;animation:spin 1s linear infinite;margin:auto;
}
@keyframes spin{100%{transform:rotate(360deg)}}

/* vs */
#vsScreen{display:none;text-align:center}
.vs{font-size:40px;margin:20px;color:#22c55e}

/* quiz */
#quiz{
display:none;width:95%;max-width:500px;
background:#0f172a;padding:25px;border-radius:16px;
}
.option{
background:#1e293b;padding:14px;margin:10px 0;
border-radius:10px;cursor:pointer;transition:.3s;
}
.option:hover{background:#334155}
.lock{background:#065f46 !important;border:2px solid #22c55e}
.timer{float:right;color:#22c55e;font-weight:bold}

/* result */
#result{display:none;text-align:center}
button{
margin-top:20px;padding:14px 24px;border:none;
border-radius:10px;background:linear-gradient(45deg,#6366f1,#06b6d4);
color:white;font-weight:bold;
}
</style>
</head>

<body>

<div id="wait">
<h2>üîé Waiting for opponent...</h2>
<div class="loader"></div>
</div>

<div id="vsScreen">
<h1 id="p1"></h1>
<div class="vs">VS</div>
<h1 id="p2"></h1>
</div>

<div id="quiz">
<div>Question <span id="qno"></span>/10 
<span class="timer">‚è± <span id="time">60</span>s</span></div>
<h3 id="question" style="margin-top:15px"></h3>
<div id="options"></div>
<button onclick="next()">Next</button>
</div>

<div id="result">
<h1>üèÜ Battle Finished</h1>
<h2 id="winner"></h2>
<button onclick="location.reload()">Play Again</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getFirestore,collection,addDoc,getDocs,doc,setDoc,onSnapshot,deleteDoc,updateDoc } 
from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

const firebaseConfig={
apiKey:"AIzaSyCEYfwfZv2Ckpg-uFLRvJkMBRlXA2w_WpI",
authDomain:"black-terminal-f2c91.firebaseapp.com",
projectId:"black-terminal-f2c91",
storageBucket:"black-terminal-f2c91.firebasestorage.app",
messagingSenderId:"552489994197",
appId:"1:552489994197:web:7662331264c334ffbadf5c"
};

const app=initializeApp(firebaseConfig);
const db=getFirestore(app);

let student=localStorage.getItem("studentName")||prompt("Enter name");
localStorage.setItem("studentName",student);

// join waiting
let myRef=await addDoc(collection(db,"battle_wait"),{
name:student,time:Date.now()
});

let started=false;
let battleId="";
let myRole="";
let myScore=0;

// listen waiting match
onSnapshot(collection(db,"battle_wait"),async(snapshot)=>{

if(started) return;

let players=[];
snapshot.forEach(doc=>players.push({id:doc.id,...doc.data()}));

if(players.length>=2){

started=true;

let p1=players[0];
let p2=players[1];
battleId="battle_"+Date.now();

await setDoc(doc(db,"battles",battleId),{
p1:p1.name,p2:p2.name,score1:0,score2:0
});

await deleteDoc(doc(db,"battle_wait",p1.id));
await deleteDoc(doc(db,"battle_wait",p2.id));

startBattle(p1.name,p2.name);
}
});

// listen if other user created battle
onSnapshot(collection(db,"battles"),(snap)=>{
if(started) return;

snap.forEach(d=>{
let data=d.data();
if(data.p1==student||data.p2==student){
started=true;
battleId=d.id;
startBattle(data.p1,data.p2);
}
});
});

function startBattle(n1,n2){
document.getElementById("wait").style.display="none";
document.getElementById("vsScreen").style.display="block";
document.getElementById("p1").innerText=n1;
document.getElementById("p2").innerText=n2;

if(student==n1) myRole="score1"; else myRole="score2";

setTimeout(()=>{
document.getElementById("vsScreen").style.display="none";
document.getElementById("quiz").style.display="block";
loadQ();
},2000);
}

// questions
const quiz=[
{q:"CPU full form?",o:["Central Process Unit","Central Processing Unit","Computer Unit","Control Unit"],a:1},
{q:"Brain of computer?",o:["RAM","CPU","Mouse","Keyboard"],a:1},
{q:"1 KB = ?",o:["1000","1024","500","2048"],a:1},
{q:"WWW full form?",o:["World Wide Web","Web World","Wide Web","None"],a:0},
{q:"Excel is?",o:["Software","Game","OS","Browser"],a:0},
{q:"Mouse is?",o:["Input","Output","CPU","RAM"],a:0},
{q:"Monitor is?",o:["Input","Output","Both","None"],a:1},
{q:"Binary of 2?",o:["10","11","01","00"],a:0},
{q:"Keyboard type?",o:["Input","Output","Storage","CPU"],a:0},
{q:"OS example?",o:["Windows","Mouse","CPU","Cable"],a:0}
];

let i=0,selected=-1,time=60;

function loadQ(){
let q=quiz[i];
document.getElementById("qno").innerText=i+1;
document.getElementById("question").innerText=q.q;

let html="";
q.o.forEach((opt,index)=>{
html+=`<div class="option" onclick="select(${index},this)">${opt}</div>`;
});
document.getElementById("options").innerHTML=html;
}

window.select=function(index,el){
if(selected!=-1) return;
selected=index;
el.classList.add("lock");

if(index==quiz[i].a){
myScore++;
updateDoc(doc(db,"battles",battleId),{[myRole]:myScore});
}
}

window.next=function(){
if(selected==-1){alert("Select option");return;}
selected=-1;i++;

if(i>=quiz.length){finish();return;}
loadQ();
}

// timer
setInterval(()=>{
time--;
document.getElementById("time").innerText=time;
if(time<=0) finish();
},1000);

// finish
function finish(){
document.getElementById("quiz").style.display="none";
document.getElementById("result").style.display="block";

onSnapshot(doc(db,"battles",battleId),(snap)=>{
let d=snap.data();
let s1=d.score1||0;
let s2=d.score2||0;
let win="Draw ü§ù";
if(s1>s2) win=d.p1+" Wins üèÜ";
if(s2>s1) win=d.p2+" Wins üèÜ";

document.getElementById("winner").innerHTML=
`${d.p1} : ${s1} | ${d.p2} : ${s2}<br>${win}`;
});
}
</script>
</body>
</html>