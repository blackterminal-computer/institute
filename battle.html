<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>1 vs 1 Battle</title>

<style>
body{
background:#020617;
color:white;
font-family:Arial;
text-align:center;
padding-top:60px;
}

.card{
background:#0f172a;
padding:25px;
border-radius:16px;
width:92%;
max-width:420px;
margin:auto;
box-shadow:0 0 40px rgba(0,0,0,0.6);
}

.avatar{
width:70px;
height:70px;
border-radius:50%;
background:#1e293b;
display:inline-block;
margin:10px;
}

.option{
background:#1e293b;
padding:14px;
margin:8px;
border-radius:10px;
cursor:pointer;
}

.timer{color:#22c55e;font-size:20px;margin:10px}
h2{color:#22c55e}
</style>
</head>

<body>

<div class="card" id="screen">
<h2>üîç Searching opponent...</h2>
<p>Please wait...</p>
</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, getDoc, deleteDoc }
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
apiKey:"AIzaSyCEYfwfZv2Ckpg-uFLRvJkMBRlXA2w_WpI",
authDomain:"black-terminal-f2c91.firebaseapp.com",
projectId:"black-terminal-f2c91",
storageBucket:"black-terminal-f2c91.appspot.com",
messagingSenderId:"552489994197",
appId:"1:552489994197:web:7662331264c334ffbadf5c"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let student = localStorage.getItem("studentName");
if(!student){
student = prompt("Enter name");
localStorage.setItem("studentName",student);
}

let roomId="";
let opponent="";
let joined=false;

startMatch();

async function startMatch(){

const waitRef = collection(db,"battle_wait");

onSnapshot(waitRef, async(snap)=>{

if(joined) return;

let players=[];
snap.forEach(d=>players.push({id:d.id,...d.data()}));

let other = players.find(p=>p.name!=student && p.status=="waiting");

if(other){
joined=true;
roomId=other.id;
opponent=other.name;

await updateDoc(doc(db,"battle_wait",roomId),{
p2:student,
status:"start"
});

listenBattle(roomId);
}
});

let ref = await addDoc(collection(db,"battle_wait"),{
name:student,
status:"waiting"
});

roomId=ref.id;
listenBattle(roomId);
}

function listenBattle(id){

onSnapshot(doc(db,"battle_wait",id),(snap)=>{
let d=snap.data();
if(!d) return;
if(d.status=="start" && d.p2){

if(d.name==student){opponent=d.p2}else{opponent=d.name}
startGame();
}
});
}

/* QUESTIONS */
let questions=[
{q:"Brain of computer?",a:"RAM",b:"CPU",c:"Mouse",d:"Keyboard",ans:"b"},
{q:"Full form of HTML?",a:"Hyper Trainer",b:"Hyper Text Markup Language",c:"High Text",d:"None",ans:"b"},
{q:"Which is input?",a:"Monitor",b:"Printer",c:"Keyboard",d:"Speaker",ans:"c"},
{q:"1 KB = ?",a:"1000",b:"1024",c:"500",d:"2000",ans:"b"},
{q:"Windows is?",a:"OS",b:"Game",c:"Browser",d:"File",ans:"a"},
{q:"Excel is?",a:"OS",b:"Software",c:"Hardware",d:"None",ans:"b"},
{q:"Mouse is?",a:"Output",b:"Input",c:"CPU",d:"RAM",ans:"b"},
{q:"Printer is?",a:"Input",b:"Output",c:"CPU",d:"RAM",ans:"b"},
{q:"Binary of 2?",a:"10",b:"11",c:"01",d:"00",ans:"a"},
{q:"Internet needs?",a:"CPU",b:"Network",c:"RAM",d:"Mouse",ans:"b"}
];

let i=0,score=0,time=10,timer;

function startGame(){
document.getElementById("screen").innerHTML=`
<h2>‚öî ${student} vs ${opponent}</h2>
<div class="timer">‚è± <span id="t">10</span></div>
<h3 id="q"></h3>
<div id="opts"></div>`;
loadQ();
}

function loadQ(){
if(i>=10){finish();return;}
time=10;document.getElementById("t").innerText=time;
let q=questions[i];
document.getElementById("q").innerText=q.q;
document.getElementById("opts").innerHTML=`
<div class="option" onclick="ans('a')">${q.a}</div>
<div class="option" onclick="ans('b')">${q.b}</div>
<div class="option" onclick="ans('c')">${q.c}</div>
<div class="option" onclick="ans('d')">${q.d}</div>`;
clearInterval(timer);
timer=setInterval(()=>{time--;document.getElementById("t").innerText=time;if(time<=0){i++;loadQ();}},1000);
}

window.ans=(a)=>{if(a==questions[i].ans)score++;i++;loadQ();}

async function finish(){
clearInterval(timer);
await updateDoc(doc(db,"battle_wait",roomId),{[student]:score});
setTimeout(async()=>{
let snap=await getDoc(doc(db,"battle_wait",roomId));
let d=snap.data();
let s1=d[d.name]||0,s2=d[d.p2]||0;
let win=(student==d.name?(s1>s2):(s2>s1));
let xp=win?100:-10;
document.getElementById("screen").innerHTML=`<h1>${win?"üèÜ You Win":"üò¢ You Lose"}</h1><h2>Score ${score}</h2><h3>XP ${xp}</h3><button onclick="location.href='index.html'">Home</button>`;
let ref=doc(db,"students",student);
let s=await getDoc(ref);
if(s.exists()){let x=s.data().xp||0;x+=xp;if(x<0)x=0;await updateDoc(ref,{xp:x});}
setTimeout(async()=>{try{await deleteDoc(doc(db,"battle_wait",roomId));}catch{}},4000);
},2000);
}

</script>
</body>
</html>