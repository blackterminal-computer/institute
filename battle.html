<!DOCTYPE html>
<html>
<head>
<title>1 vs 1 Battle</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
margin:0;
font-family:Arial;
background:#020617;
color:white;
display:flex;
justify-content:center;
align-items:center;
height:100vh;
text-align:center;
}

.box{
width:95%;
max-width:600px;
background:#0f172a;
padding:25px;
border-radius:18px;
}

.opt{
background:#1f2937;
padding:14px;
margin-top:12px;
border-radius:10px;
cursor:pointer;
}

button{
padding:14px 25px;
border:none;
border-radius:10px;
background:linear-gradient(45deg,#6366f1,#06b6d4);
color:white;
margin-top:15px;
}
</style>
</head>

<body>

<div class="box" id="screen">
<h2>‚öî Waiting for opponent...</h2>
</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, doc, setDoc, onSnapshot, deleteDoc } 
from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

const firebaseConfig = {
apiKey:"AIzaSyCEYfwfZv2Ckpg-uFLRvJkMBRlXA2w_WpI",
authDomain:"black-terminal-f2c91.firebaseapp.com",
projectId:"black-terminal-f2c91",
storageBucket:"black-terminal-f2c91.firebasestorage.app",
messagingSenderId:"552489994197",
appId:"1:552489994197:web:7662331264c334ffbadf5c"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let student = localStorage.getItem("studentName");
if(!student){
student = prompt("Enter name");
localStorage.setItem("studentName",student);
}

// questions
let quiz=[
{q:"Brain of computer?",o:["RAM","CPU","Mouse","Keyboard"],a:1},
{q:"Excel is?",o:["Software","Game","OS","Browser"],a:0},
{q:"1 KB = ?",o:["1000","1024","500","200"],a:1},
{q:"WWW full form?",o:["World Wide Web","Web","Wide","None"],a:0}
];

// join waiting room
let myRef = await addDoc(collection(db,"battle_wait"),{
name:student,
time:Date.now()
});

// listen battle start
onSnapshot(collection(db,"battles"),(snap)=>{
snap.forEach(d=>{
let data=d.data();
if(data.p1==student || data.p2==student){
startGame(d.id,data);
}
});
});

// check opponent
setInterval(async ()=>{
let snap = await getDocs(collection(db,"battle_wait"));
let players=[];
snap.forEach(d=>players.push({id:d.id,...d.data()}));

if(players.length>=2){

let p1=players[0];
let p2=players[1];

let battleId="battle_"+Date.now();

await setDoc(doc(db,"battles",battleId),{
p1:p1.name,
p2:p2.name,
score1:0,
score2:0
});

// delete waiting
await deleteDoc(doc(db,"battle_wait",p1.id));
await deleteDoc(doc(db,"battle_wait",p2.id));
}
},2000);

function startGame(battleId,data){

let me=student;
let opponent= me==data.p1?data.p2:data.p1;

let i=0,score=0;

function load(){
let q=quiz[i];
let html=`<h2>‚öî ${me} vs ${opponent}</h2>
<h3>${q.q}</h3>`;

q.o.forEach((opt,idx)=>{
html+=`<div class="opt" onclick="ans(${idx})">${opt}</div>`;
});

document.getElementById("screen").innerHTML=html;
}
load();

window.ans=async function(idx){
if(idx==quiz[i].a) score++;
i++;

await setDoc(doc(db,"battles",battleId),{
[me==data.p1?"score1":"score2"]:score
},{merge:true});

if(i<quiz.length) load();
else finish();
}

function finish(){
document.getElementById("screen").innerHTML="<h2>Waiting result...</h2>";

onSnapshot(doc(db,"battles",battleId),(d)=>{
let r=d.data();
if(!r) return;

let my = me==r.p1?r.score1:r.score2;
let opp = me==r.p1?r.score2:r.score1;

let res="Draw ü§ù";
if(my>opp) res="üèÜ You Win!";
if(my<opp) res="üò¢ You Lose";

document.getElementById("screen").innerHTML=
`<h1>${res}</h1>
<h2>${my} vs ${opp}</h2>
<button onclick="location.reload()">Play Again</button>`;
});
}
}

</script>
</body>
</html>