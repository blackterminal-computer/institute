<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Students Payment Control</title>

<style>
body{background:#020617;color:white;font-family:Arial;text-align:center;padding:20px}

.card{
background:#0f172a;
padding:25px;
border-radius:16px;
max-width:520px;
margin:auto;
margin-top:20px
}

button{
padding:12px 18px;
border:none;
border-radius:10px;
margin:5px;
font-weight:bold;
color:white
}

.paid{background:#22c55e}
.complete{background:orange}
.del{background:red}
.reset{background:#6366f1}

.student{
background:#111827;
padding:18px;
margin:12px;
border-radius:14px
}

.overdue{color:red;font-weight:bold}
.paidtxt{color:#22c55e;font-weight:bold}
.completeTxt{color:#38bdf8;font-weight:bold}
.xp{color:#facc15;font-weight:bold}
</style>
</head>
<body>

<div class="card">
<h2>üë®‚Äçüíª Students Payment Control (<span id="totalStudents">0</span>)</h2>
<div id="list">Loading...</div>
</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, doc, getDocs, collection, updateDoc, deleteDoc, setDoc }
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig={
apiKey:"AIzaSyCEYfwfZv2Ckpg-uFLRvJkMBRlXA2w_WpI",
authDomain:"black-terminal-f2c91.firebaseapp.com",
projectId:"black-terminal-f2c91",
storageBucket:"black-terminal-f2c91.appspot.com",
messagingSenderId:"552489994197",
appId:"1:552489994197:web:7662331264c334ffbadf5c"
};

const app=initializeApp(firebaseConfig);
const db=getFirestore(app);

load();

/* AUTO ADD STUDENTS */
async function autoFetchStudents(){

let studentsSnap = await getDocs(collection(db,"students"));
let paySnap = await getDocs(collection(db,"payments"));

let existing = [];
paySnap.forEach(d=>existing.push(d.id));

studentsSnap.forEach(async(d)=>{
let name=d.id;

if(!existing.includes(name)){
await setDoc(doc(db,"payments",name),{
name:name,
status:"OVERDUE",
lastPaid:""
});
}
});
}

/* MARK PAID */
window.markPaid=async function(name){
let today=new Date().toLocaleDateString();

await updateDoc(doc(db,"payments",name),{
status:"PAID",
lastPaid:today
});
load();
}

/* COMPLETE */
window.complete=async function(name){
await updateDoc(doc(db,"payments",name),{
status:"COMPLETED"
});
load();
}

/* üî• DELETE FULL STUDENT */
window.del=async function(name){

if(!confirm("Delete "+name+" completely?")) return;

try{
await deleteDoc(doc(db,"payments",name)); // payment delete
}catch{}

try{
await deleteDoc(doc(db,"students",name)); // student xp delete
}catch{}

alert("Deleted "+name);
load();
}

/* RESET XP */
window.resetXP=async function(name){
if(!confirm("Reset XP of "+name+" ?")) return;

await updateDoc(doc(db,"students",name),{
xp:0
});

alert("XP Reset Done");
load();
}

/* LOAD */
async function load(){

await autoFetchStudents();

let paySnap=await getDocs(collection(db,"payments"));
let studentSnap=await getDocs(collection(db,"students"));

let xpMap={};
studentSnap.forEach(d=>{
xpMap[d.id]=d.data().xp || 0;
});

let html="";
let count=1;

if(paySnap.empty){
document.getElementById("list").innerHTML="No students";
document.getElementById("totalStudents").innerText=0;
return;
}

paySnap.forEach(d=>{
let s=d.data();
let xp=xpMap[s.name] || 0;

let statusHtml="";
if(s.status=="PAID") statusHtml=`<span class="paidtxt">PAID</span>`;
else if(s.status=="COMPLETED") statusHtml=`<span class="completeTxt">COURSE COMPLETED</span>`;
else statusHtml=`<span class="overdue">OVERDUE</span>`;

html+=`
<div class="student">
<h3>${count}. ${s.name}</h3>

<div class="xp">‚≠ê XP: ${xp}</div><br>

Status: ${statusHtml}<br>
${s.lastPaid ? "Paid Date: "+s.lastPaid : ""}<br><br>

<button class="paid" onclick="markPaid('${s.name}')">Mark Paid</button>
<button class="complete" onclick="complete('${s.name}')">Course Completed</button>
<button class="reset" onclick="resetXP('${s.name}')">Reset XP</button>
<button class="del" onclick="del('${s.name}')">Delete Student</button>
</div>
`;
count++;
});

document.getElementById("list").innerHTML=html;
document.getElementById("totalStudents").innerText=count-1;

}

</script>
</body>
</html>