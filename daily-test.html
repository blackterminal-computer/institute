<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Daily Exam</title>

<style>
body{background:#020617;color:white;font-family:Arial;text-align:center;padding:20px}
.card{background:#0f172a;padding:25px;border-radius:18px;max-width:600px;margin:auto;margin-top:30px}
.opt{display:block;background:#111827;margin:8px;padding:14px;border-radius:12px;cursor:pointer}
.lock{opacity:0.5;pointer-events:none}
button{padding:12px 18px;margin-top:15px;border:none;border-radius:10px;font-size:16px;background:linear-gradient(90deg,#6366f1,#06b6d4);color:white}
.timer{font-size:20px;color:#22c55e}
</style>
</head>
<body>

<div class="card" id="examBox">
<h2>üß† Daily Exam</h2>
<div class="timer" id="timer">Loading...</div>
<h3 id="q">Loading...</h3>
<div id="options"></div>
<button onclick="nextQ()">Next</button>
</div>

<div class="card" id="lockBox" style="display:none">
<h2>üîí Test Completed</h2>
<h3>Next test unlock in</h3>
<h1 id="count"></h1>
</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, getDocs, doc, getDoc, setDoc }
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig={
apiKey:"AIzaSyCEYfwfZv2Ckpg-uFLRvJkMBRlXA2w_WpI",
authDomain:"black-terminal-f2c91.firebaseapp.com",
projectId:"black-terminal-f2c91",
storageBucket:"black-terminal-f2c91.appspot.com",
messagingSenderId:"552489994197",
appId:"1:552489994197:web:7662331264c334ffbadf5c"
};

const app=initializeApp(firebaseConfig);
const db=getFirestore(app);

let student=localStorage.getItem("studentName")||"Student";

/* üîí DAILY LOCK */
let last=localStorage.getItem("daily_done_"+student);
let today=new Date().toDateString();

if(last==today){
lockScreen();
}else{
loadQ();
}

function lockScreen(){
document.getElementById("examBox").style.display="none";
document.getElementById("lockBox").style.display="block";

setInterval(()=>{
let now=new Date();
let tomorrow=new Date();
tomorrow.setHours(24,0,0,0);

let diff=tomorrow-now;
let h=Math.floor(diff/1000/60/60);
let m=Math.floor(diff/1000/60)%60;
let s=Math.floor(diff/1000)%60;

document.getElementById("count").innerHTML=
h+"h "+m+"m "+s+"s";
},1000);
}

let questions=[];
let index=0;
let score=0;
let selected="";
let locked=false;
let time=20;

/* LOAD QUESTIONS */
async function loadQ(){
let snap=await getDocs(collection(db,"daily_mcq"));

snap.forEach(d=>{
questions.push(d.data());
});

questions.sort(()=>Math.random()-0.5);
questions=questions.slice(0,20);

showQ();
timer();
}

function showQ(){
if(index>=questions.length){
finish();
return;
}

let q=questions[index];
document.getElementById("q").innerHTML=`Q${index+1}. ${q.question}`;

document.getElementById("options").innerHTML=`
<div class="opt" onclick="select('A',this)">A. ${q.a}</div>
<div class="opt" onclick="select('B',this)">B. ${q.b}</div>
<div class="opt" onclick="select('C',this)">C. ${q.c}</div>
<div class="opt" onclick="select('D',this)">D. ${q.d}</div>
`;

selected="";
locked=false;
time=20;
}

window.select=function(v,el){
if(locked) return;
selected=v;
locked=true;

document.querySelectorAll(".opt").forEach(o=>o.classList.add("lock"));
el.style.background="#22c55e";
}

window.nextQ=function(){
if(!locked) return alert("Select option");

let q=questions[index];
if(selected==q.correct) score++;

index++;
showQ();
}

function timer(){
setInterval(()=>{
time--;
document.getElementById("timer").innerHTML="‚è± "+time+"s";

if(time<=0){
index++;
showQ();
time=20;
}
},1000);
}

/* üî• FINISH */
async function finish(){

let todayDate=new Date();
let todayStr=todayDate.toDateString();

// lock today
localStorage.setItem("daily_done_"+student,todayStr);

/* üî• XP + STREAK FIREBASE */
let xpRef = doc(db,"students",student);
let snap = await getDoc(xpRef);

let currentXP=0;
let streak=1;

if(snap.exists()){
currentXP=snap.data().xp||0;
streak=snap.data().streak||0;
}

currentXP+=100;

/* streak calc */
let lastPlay=localStorage.getItem("last_play_"+student);
let yesterday=new Date();
yesterday.setDate(todayDate.getDate()-1);

if(lastPlay==yesterday.toDateString()){
streak+=1;
}else if(lastPlay==todayStr){
}else{
streak=1;
}

localStorage.setItem("last_play_"+student,todayStr);

await setDoc(xpRef,{
xp:currentXP,
streak:streak
},{merge:true});

alert(`üèÜ Test Completed!
Score: ${score}/20
+100 XP added
üî• Streak: ${streak} days`);

window.location="leaderboard.html";
}

</script>
</body>
</html>