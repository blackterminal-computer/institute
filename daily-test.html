<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Daily Test</title>

<style>
body{
background:#020617;
font-family:Arial;
color:white;
text-align:center;
padding:20px;
}

.card{
background:#0f172a;
padding:25px;
border-radius:18px;
max-width:420px;
margin:auto;
box-shadow:0 0 40px rgba(0,0,0,0.6);
}

.option{
background:#1e293b;
padding:16px;
border-radius:12px;
margin:10px 0;
cursor:pointer;
transition:0.3s;
}

.option:hover{
background:#334155;
}

.option.selected{
border:2px solid #22c55e;
box-shadow:0 0 15px #22c55e,0 0 40px #22c55e inset;
animation:lock 0.3s ease;
}

@keyframes lock{
0%{transform:scale(1)}
50%{transform:scale(0.9)}
100%{transform:scale(1)}
}

button{
margin-top:15px;
padding:14px;
width:100%;
border:none;
border-radius:12px;
font-size:18px;
font-weight:bold;
background:linear-gradient(90deg,#6366f1,#06b6d4);
color:white;
}

.timer{
color:#22c55e;
font-size:18px;
}
</style>
</head>

<body>

<div class="card" id="app">
<h2>üß† Daily Test</h2>
<p>Loading...</p>
</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, getDocs, doc, updateDoc, getDoc }
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
apiKey:"AIzaSyCEYfwfZv2Ckpg-uFLRvJkMBRlXA2w_WpI",
authDomain:"black-terminal-f2c91.firebaseapp.com",
projectId:"black-terminal-f2c91",
storageBucket:"black-terminal-f2c91.appspot.com",
messagingSenderId:"552489994197",
appId:"1:552489994197:web:7662331264c334ffbadf5c"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let student = localStorage.getItem("studentName");
let questions=[];
let index=0;
let score=0;
let selected=null;
let time=1200; // 20 min

start();

async function start(){

let snap = await getDocs(collection(db,"daily_mcq"));
snap.forEach(d=> questions.push(d.data()));

questions = questions.sort(()=>0.5-Math.random()).slice(0,20);

showQ();
timer();
}

function showQ(){

if(index>=questions.length){
finish();
return;
}

let q=questions[index];

document.getElementById("app").innerHTML=`
<h2>üß† Daily Test</h2>
<div class="timer">‚è± ${time}s</div>
<h3>Q${index+1}. ${q.q}</h3>

<div class="option" onclick="selectOption(this,'A')">${q.a}</div>
<div class="option" onclick="selectOption(this,'B')">${q.b}</div>
<div class="option" onclick="selectOption(this,'C')">${q.c}</div>
<div class="option" onclick="selectOption(this,'D')">${q.d}</div>

<button onclick="nextQ()">Next</button>
`;
}

window.selectOption = function(el,ans){

document.querySelectorAll(".option").forEach(o=>{
o.classList.remove("selected");
});

el.classList.add("selected");
selected=ans;
}

window.nextQ = function(){

if(!selected){
alert("Select option");
return;
}

if(selected==questions[index].correct){
score++;
}

selected=null;
index++;
showQ();
}

function timer(){

setInterval(()=>{
time--;
let t=document.querySelector(".timer");
if(t) t.innerHTML="‚è± "+time+"s";

if(time<=0) finish();
},1000);
}

async function finish(){

let xpEarn = score*2;

// update xp
let ref = doc(db,"students",student);
let snap = await getDoc(ref);
let xp = snap.data()?.xp || 0;

await updateDoc(ref,{
xp: xp + xpEarn
});

// leaderboard
await updateDoc(ref,{
lastScore:score
});

document.getElementById("app").innerHTML=`
<h1>üèÅ Test Finished</h1>
<h2 style="color:#22c55e">Score: ${score}</h2>
<h3>XP Earned: ${xpEarn}</h3>

<button onclick="goHome()">üè† Home</button>
`;
}

window.goHome=function(){
window.location.href="index.html";
}

</script>
</body>
</html>